---
title: "远程桌面利用"
date: 2025-12-11T00:00:00+08:00
draft: false
---

# 远程桌面利用

即RDP，默认TCP 3389端口

可以通过获取凭据，RDP连接进行横向移动，缺点是可能将已登陆的用户强制退出，容易被管理员发现

### 远程桌面的确定开启

查询注册表确定主机是否开启了远程桌面：

~~~cmd
reg query "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections 
~~~

![image-20241026165014449](https://img2023.cnblogs.com/blog/3450279/202410/3450279-20241026165019723-343288390.png)

若字段值为0x0说明RDP服务已启动；若为0x1，则说明RDP服务禁用

cmd命令开启远程桌面：

~~~cmd
#开启服务
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
#关闭“仅允许运行使用网络级别身份验证的远程桌面计算机连接”(鉴权)
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 
#设置防火墙策略放行3389端口
netsh advfirewall firewall add rule name="Remote Desktop" protocol=TCP dir=in localport=3389 action=allow
~~~

![image-20241026170323725](https://img2023.cnblogs.com/blog/3450279/202410/3450279-20241026170329427-68205362.png)

对远程主机，可使用WMI来开启远程桌面服务（要指定远程主机的IP、主机名和用户凭据）：

~~~cmd
wmic /Node:192.168.111.137 /User:yuy0ung\administrator /Password:Admin123456 RDTOGGLE WHERE ServerName="client01" call SetAllowTSConnections 1
~~~

![image-20241026171028751](https://img2023.cnblogs.com/blog/3450279/202410/3450279-20241026171033838-1085504768.png)

### RDP Hijacking

对于开启远程桌面的windows主机，当多个用户进行登录时，会产生多个会话。若获取了system权限，则可以劫持其他用户的RDP会话，并在未授权的情况下成功登入目标系统（即使该用户的会话已断开），即远程桌面劫持

RDP Hijacking需要获取system权限并执行tson命令

该命令可以切换会话，system权限下可不输入密码切换会话，造成劫持：

* rdp登录用户apache：

  ![image-20241026212536310](https://img2023.cnblogs.com/blog/3450279/202410/3450279-20241026212538739-822286476.png)

* 获取system权限：

  ![image-20241026205327743](https://img2023.cnblogs.com/blog/3450279/202410/3450279-20241026205329230-913670298.png)

* 查看用户会话记录：

  ~~~cmd
  query user
  ~~~

  ![image-20241026212618810](https://img2023.cnblogs.com/blog/3450279/202410/3450279-20241026212619727-1917783845.png)

  发现administrator和apache用户的会话

* 尝试切换为administrator：

  ~~~cmd
  tscon 1
  ~~~

* 这里按道理来说rdp应该会切换到administrator，但这里显示access is denied，不知道原因，我都已经system权限了。。。。

### SharpRDP

通过远程桌面协议在远程主机上执行系统命令且无需GUI

优点：在远控内网主机时无需做代理，将工具上传至跳板机即可实现对内网主机的命令执行